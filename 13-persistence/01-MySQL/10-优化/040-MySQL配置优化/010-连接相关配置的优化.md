# 010-连接相关配置的优化

[TOC]

## 连接问题的典型报错

> Mysql: error 1040: Too many connections

有可能是服务端连接数不够导致应用程序获取不到连接

#### 解决办法

- [从服务端来说,我们可以增加服务端的可用连接数](#从服务端来说,我们可以增加服务端的可用连接数)

- [从客户端来说,引入连接池,实现连接的重用](#从客户端来说,引入连接池,实现连接的重用)

## 从服务端来说,我们可以增加服务端的可用连接数

- 修改配置参数增加可用连接数，修改 max_connections 的大小:

```sql
show variables like 'max_connections';   -- 修改最大连接数，当有多个应用连接的时候
```

- 及时释放不活动的连接。交互式和非交互式的客户端的默认超时间都是 28800 秒，8 小时，我们可以把这个值调小

```sql
show global variables like 'wait_timeout'; --及时释放不活动的连接，注意不要释放连接池还在使用的连接
```

## 从客户端来说,引入连接池,实现连接的重用

阿里的 Druid、Spring Boot 2.x 版本默认的连接池 Hikari、老牌的 DBCP 和 C3P0

#### 连接池核心数应该配置多少

- Druid 的默认最大连接池大小是 8。
- Hikari 的默认最大连接池大小是 10。

[HikariCP建议的公式](https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing)

> ##### connections = ((core_count * 2) + effective_spindle_count)
>
> 机器核数乘以 2 加 1 , 也就是说，4 核的机器，连接池维护 9 个连接就够了

#### 为什么不是越多越好

显然不是,CPU 是怎么同时执行远远超过它的核数大小的任务的?时间片。上下文切换。 而 CPU 的核数是有限的，频繁的上下文切换会造成比较大的性能开销。

## 有时候减少连接数可以提高吞吐量

为什么有的情况下，减少连接数反而会提升吞吐量呢? 为什么建议设置的连接池大小要跟 CPU 的核数相关呢?

每一个连接，服务端都需要创建一个线程去处理它。连接数越多，服务端创建的线程数就会越多。

CPU 是怎么同时执行远远超过它的核数大小的任务的?时间片。上下文切换。

而 CPU 的核数是有限的，频繁的上下文切换会造成比较大的性能开销。

在不同的硬件环境下，操作系统和 MySQL 的参数的配置是不同的，没有标准的配置。

在我们这几天的课程里面也接触了很多的 MySQL 和 InnoDB 的配置参数，包括各种 开关和数值的配置，大多数参数都提供了一个默认值，比如默认的 buffer_pool_size， 默认的页大小，InnoDB 并发线程数等等。

这些默认配置可以满足大部分情况的需求，除非有特殊的需求，在清楚参数的含义 的情况下再去修改它。修改配置的工作一般由专业的 DBA 完成。

如果想要了解一些特定的参数的含义，官网有一份系统的参数列表可以参考:

> https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html 

