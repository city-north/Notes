# 010-Redis过期键删除策略

[TOC]

## 一句话概括

Redis采用惰性删除和定期删除来保证内存

## 过期键删除策略

如果一个键过期了, 怎么什么时候删除呢

- 定时删除(Redis不支持) : 在设置键过期时间的同时, 创建了一个定时器(timer), 让定时器在键的过期时间来临时、立即执行对键的删除操作
- 惰性删除 : 放任键过期不管, 但是每次从键空间中获取键时, 都会检查取得的键是否过期
  - 如果过期, 就删除
  - 如果没有过期, 就返回
- 定期删除
  - 每个一段时间, 程序会对数据库进行一次检查, 删除里面的过期键, 至于要删除多少过期键, 要有策略决定

## 1.定时删除

(Redis未使用)

#### 1.1优点

定时删除策略是对内存最友好的,  通过使用定时器, 定时删除策略可以保证过期键会尽快的被删除, 并释放过期键锁占用的内存

#### 1.2缺点

对CPU不友好,在过期键比较多的情况下, 删除过期键这一行为可能会占用一部分的CPU时间

- 在内存不紧张但是CPU紧张的时候, 会造成吞吐量和相应时间影响

## 2.惰性删除

只有当访问一个 key 时，才会判断该 key 是否已过期，过期则清除。

- 该策略可以最 大化地节省 CPU 资源，却对内存非常不友好。

- 极端情况可能出现大量的过期 key 没有再次被访问，从而不会被清除，占用大量内存。

## 3.定期删除

Redis 定时扫描默认是每秒进行 10 次过期扫描,过期扫描不会遍历过期字典中的所有的 key,而是采用了一种贪心策略

1. 从过期字典中随机选择 20 个 key
2. 删除这20 个key 中已经过期的 key
3. 如果过期的 key 的比例超过 1/4, 那么就重复步骤 1

> 为了防止线程卡死,算法增加了扫描时间的上限,默认是 25ms
