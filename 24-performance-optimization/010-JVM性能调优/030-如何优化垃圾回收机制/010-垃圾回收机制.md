# 010-垃圾回收机制

[TOC]

## 前言

在 Java 开发中，开发人员是无需过度关注对象的回收与释放的，JVM 的垃圾回收机制可以减轻不少工作量。但完全交由 JVM 回收对象，也会增加回收性能的不确定性。在一些特殊的业务场景下，不合适的垃圾回收算法以及策略，都有可能导致系统性能下降。

面对不同的业务场景，垃圾回收的调优策略也不一样。例如，

- 在对内存要求苛刻的情况下，需要提高对象的回收效率；
- 在 CPU 使用率高的情况下，需要降低高并发时垃圾回收的频率。

可以说，垃圾回收的调优是一项必备技能。

这讲我们就把这项技能的学习进行拆分，看看回收（后面简称 GC）的算法有哪些，体现 GC 算法好坏的指标有哪些，又如何根据自己的业务场景对 GC 策略进行调优？

## 1. 回收发生在哪里？

JVM 的内存区域中，程序计数器、虚拟机栈和本地方法栈这 3 个区域是线程私有的，随着线程的创建而创建，销毁而销毁；

栈中的栈帧随着方法的进入和退出进行入栈和出栈操作，每个栈帧中分配多少内存基本是在类结构确定下来的时候就已知的，因此这三个区域的内存分配和回收都具有确定性。

那么垃圾回收的重点就是关注**堆和方法区**中的内存了，

- 堆中的回收主要是对象的回收
- 方法区的回收主要是废弃常量和无用的类的回收

## 2. 对象在什么时候可以被回收？

那 JVM 又是怎样判断一个对象是可以被回收的呢？一般一个对象不再被引用，就代表该对象可以被回收。目前有以下两种算法可以判断该对象是否可以被回收。

**引用计数算法：**这种算法是通过一个对象的引用计数器来判断该对象是否被引用了。

- 每当对象被引用，引用计数器就会加 1；

- 每当引用失效，计数器就会减 1。当对象的引用计数器的值为 0 时，就说明该对象不再被引用，可以被回收了。这里强调一点，虽然引用计数算法的实现简单，判断效率也很高，但它存在着对象之间相互循环引用的问题。

**可达性分析算法：**GC Roots 是该算法的基础，GC Roots 是所有对象的根对象，在 JVM 加载时，会创建一些普通对象引用正常对象。这些对象作为正常对象的起始点，在垃圾回收时，会从这些 GC Roots 开始向下搜索，当一个对象到 GC Roots 没有任何引用链相连时，就证明此对象是不可用的。目前 HotSpot 虚拟机采用的就是这种算法。

以上两种算法都是通过引用来判断对象是否可以被回收。在 JDK 1.2 之后，Java 对引用的概念进行了扩充，将引用分为了以下四种：

 [03-什么是对象引用.md](../../../07-jvm/03-垃圾收集器与内存分配策略/03-什么是对象引用.md) 

| 对象引用                | 实现类           | 特征                                                         |
| ----------------------- | ---------------- | ------------------------------------------------------------ |
| 强引用(StrongReference) |                  | 有强引用的对象一定为可达性状态,所以不会被 垃圾回收期回收,强引用是造成Java内存泄漏的主要原因 |
| 软引用-可以被回收的引用 | SoftReference    | 如果一个对象只有软引用,则在系统空间将要发生内存溢出时, 才会去回收软引用引用的对象 |
| 弱引用-发现即回收       | WeakReference    | 如果一个对象只有弱引用,则在垃圾回收过程中一定会被回收        |
| 虚引用-对象回收跟踪     | PhantomReference | 虚引用和引用队列联合使用,主要用于跟踪对象的垃圾回收状态      |

## 3. 如何回收这些对象？

了解完 Java 程序中对象的回收条件，那么垃圾回收线程又是如何回收这些对象的呢？JVM 垃圾回收遵循以下两个特性。

- **自动性：**Java 提供了一个系统级的线程来跟踪每一块分配出去的内存空间，当 JVM 处于空闲循环时，垃圾收集器线程会自动检查每一块分配出去的内存空间，然后自动回收每一块空闲的内存块。

- **不可预期性：**一旦一个对象没有被引用了，该对象是否立刻被回收呢？答案是不可预期的。我们很难确定一个没有被引用的对象是不是会被立刻回收掉，因为有可能当程序结束后，这个对象仍在内存中。

垃圾回收线程在 JVM 中是自动执行的，Java 程序无法强制执行。我们唯一能做的就是通过调用 System.gc 方法来"建议"执行垃圾收集器，但是否可执行，什么时候执行？仍然不可预期。

