# 060-热点检测

[TOC]

## 什么是热点检测

在 HotSpot 虚拟机中的热点探测是 JIT 优化的条件，热点探测是基于计数器的热点探测，采用这种方法的虚拟机会为每个方法建立计数器统计方法的执行次数，如果执行次数超过一定的阈值就认为它是“热点方法” 。

虚拟机为每个方法准备了两类计数器：

- 方法调用计数器（Invocation Counter）
- 回边计数器（Back Edge Counter）

在确定虚拟机运行参数的前提下，这两个计数器都有一个确定的阈值，当计数器超过阈值溢出了，就会触发 JIT 编译。

## 1.方法调用计数器

用于统计方法被调用的次数，

- 方法调用计数器的默认阈值在 C1 模式下是 1500 次，

- 在 C2 模式在是 10000 次，可通过 -XX: CompileThreshold 来设定；

而在分层编译的情况下，-XX: CompileThreshold 指定的阈值将失效，此时将会根据当前待编译的方法数以及编译线程数来动态调整。

当方法计数器和回边计数器之和超过方法计数器阈值时，就会触发 JIT 编译器。

## 2.回边计数器

用于统计一个方法中循环体代码执行的次数，在字节码中遇到控制流向后跳转的指令称为“回边”（Back Edge），该值用于计算是否触发 C1 编译的阈值，在不开启分层编译的情况下，

- C1 默认为 13995
- C2 默认为 10700，可通过 `-XX: OnStackReplacePercentage=N` 来设置；

而在分层编译的情况下，-XX: OnStackReplacePercentage 指定的阈值同样会失效，此时将根据当前待编译的方法数以及编译线程数来动态调整。

建立回边计数器的主要目的是为了触发 OSR（On StackReplacement）编译，即栈上编译。

在一些循环周期比较长的代码段中，当循环达到回边计数器阈值时，JVM 会认为这段是热点代码，JIT 编译器就会将这段代码编译成机器语言并缓存，在该循环时间段内，会直接将执行代码替换，执行缓存的机器语言。

