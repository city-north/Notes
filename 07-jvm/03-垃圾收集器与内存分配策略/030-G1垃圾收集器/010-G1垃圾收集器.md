# 010-G1垃圾收集器

[TOC]

## G1垃圾收集器要点

- 基于Region的内存布局形式
- 可预测的停顿模型（Pause Prediction Model）

### 特点1:基于Region的内存布局形式

在G1算法中，采用了另外一种完全不同的方式组织堆内存，堆内存被划分为多个大小相等的内存块（Region），

每个Region是逻辑连续的一段内存，结构如下：

![image-20200908195159285](../../../assets/image-20200908195159285.png)

每个Region被标记了E、S、O和H，说明每个Region在运行时都充当了一种角色，

- 其中H是以往算法中没有的，它代表Humongous，这表示这些Region存储的是巨型对象（humongous object，H-obj），当新建对象大小超过Region大小一半时，直接在新的一个或多个连续Region中分配，并标记为H。

## 特点2:可预测的停顿模型（Pause Prediction Model）

停顿时间模型的意思是能够支持指定在一个长度为M毫秒的时间片段内，消耗在垃圾收集上的时间大概率不超过N毫秒这样的目标，这几乎已经是实时Java（RTSJ）的中软实时垃圾收集器特征了。 

那具体要怎么做才能实现这个目标呢？

首先要有一个思想上的改变，在G1收集器出现之前的所有其他收集器，包括CMS在内，垃圾收集的目标范围

- 要么是整个新生代（Minor GC）
- 要么就是整个老 年代（Major GC）
- 再要么就是整个Java堆（Full GC）

而G1跳出了这个樊笼，它可以面向堆内存任何部分来组成回收集（Collection Set，一般简称CSet）进行回收，衡量标准不再是它属于哪个分代，而是哪块内存中存放的垃圾数量最多，回收收益最大，这就是G1收集器的Mixed GC模式。

G1收集器的停顿 预测模型是以衰减均值（Decaying Average）为理论基础来实现的，在垃圾收集过程中，G1收集器会记 录每个Region的回收耗时、每个Region记忆集里的脏卡数量等各个可测量的步骤花费的成本，并分析得 出平均值、标准偏差、置信度等统计信息。

这里强调的“衰减平均值”是指它会比普通的平均值更容易 受到新数据的影响，平均值代表整体平均状态，但衰减平均值更准确地代表“最近的”平均状态。

换句话说，Region的统计状态越新越能决定其回收的价值。然后通过这些信息预测现在开始回收的话，由 哪些Region组成回收集才可以在不超过期望停顿时间的约束下获得最高的收益。

## 总结

**它设定的目标是在延迟可控的情况下获得尽可能高的吞吐量**

G1回收器（Garbage-First）是在JDK 1.7中正式使用的全新的垃圾回收器，从长期目标来看，它是为了**取代CMS回收器**。

G1回收器拥有独特的垃圾回收策略，和之前提到的回收器截然不同。

- 从分代上看，G1依然属于分代垃圾回收器，它会区分年轻代和老年代，依然有eden区和survivor区，
- 但从堆的结构上看，它并不要求整个eden区、年轻代或者老年代都连续。
- 它使用了分区算法。作为CMS的长期替代方案，G1使用了全新的分区算法，其特点如下。

| 特性     | 详情                                                         |
| -------- | ------------------------------------------------------------ |
| 并行性   | **G1在回收期间，可以由多个GC线程同时工作，有效利用多核计算能力。** |
| 并发性   | G1 拥有与应用程序交替执行的能力，部分工作可以和应用程序同时执行，一般来说，不会在整个回收期间完全阻塞应用程序。 |
| 分代 GC  | G1 依然是一个分代回收器，但是和之前的回收器不同，它同时兼顾年轻代和老年代，其他回收器或者工作在年轻代，或者工作在老年代。 |
| 空间整理 | G1在回收过程中，会进行适当的对象移动，不像CMS，只是简单地标记清理对象，在若干次GC后，CMS必须进行一次碎片整理。<br />而G1不同，它每次回收都会有效地复制对象，减少碎片空间。 |
| 可预见性 | 由于分区的原因，G1 可以只选取部分区域进行内存回收，这样缩小了回收的范围，全局停顿也能得到较好的控制。 |

**延迟可控的情况下获得尽可能高的吞吐量**

G1(Garbage First) **延迟可控的情况下获得尽可能高的吞吐量** 是垃圾收集器技术的新思路 , JDK7 默认垃圾收集器

- 针对**停顿时间模型**
- 面向局部收集的设计思路
- [基于Region的内存布局形式](#基于Region的内存布局形式)
- 是一款 **面向服务器端应用的垃圾收集器**

