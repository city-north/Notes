# HashMap çš„åº•å±‚åŸç†

> https://github.com/AobingJava/JavaFamily/blob/master/docs/basics/HashMap.md

## **æ•°ç»„å’Œé“¾è¡¨ç»„åˆæ„æˆ**

![image-20200326222215890](assets/image-20200326222215890.png)

HashMapæ˜¯ç”±**æ•°ç»„å’Œé“¾è¡¨ç»„åˆæ„æˆ**çš„æ•°æ®ç»“æ„ã€‚æ•°ç»„é‡Œé¢æ¯ä¸ªåœ°æ–¹éƒ½å­˜äº†Key-Valueè¿™æ ·çš„å®ä¾‹ï¼Œåœ¨Java7å«Entryåœ¨Java8ä¸­å«Nodeã€‚

å› ä¸ºä»–æœ¬èº«æ‰€æœ‰çš„ä½ç½®éƒ½ä¸ºnullï¼Œåœ¨putæ’å…¥çš„æ—¶å€™ä¼šæ ¹æ®keyçš„hashå»è®¡ç®—ä¸€ä¸ªindexå€¼ã€‚

å°±æ¯”å¦‚æˆ‘putï¼ˆâ€å¸…ä¸™â€œï¼Œ520ï¼‰ï¼Œæˆ‘æ’å…¥äº†ä¸ºâ€å¸…ä¸™â€œçš„å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºæ’å…¥çš„ä½ç½®ï¼Œè®¡ç®—å‡ºæ¥indexæ˜¯2é‚£ç»“æœå¦‚ä¸‹ã€‚

> hashï¼ˆâ€œå¸…ä¸™â€ï¼‰= 2

![image-20200326222400671](assets/image-20200326222400671.png)

## ä¸ºå•¥éœ€è¦é“¾è¡¨ï¼Œé“¾è¡¨åˆæ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

æˆ‘ä»¬éƒ½çŸ¥é“æ•°ç»„é•¿åº¦æ˜¯æœ‰é™çš„ï¼Œåœ¨æœ‰é™çš„é•¿åº¦é‡Œé¢æˆ‘ä»¬ä½¿ç”¨å“ˆå¸Œï¼Œå“ˆå¸Œæœ¬èº«å°±å­˜åœ¨æ¦‚ç‡æ€§ï¼Œå°±æ˜¯â€å¸…ä¸™â€œå’Œâ€ä¸™å¸…â€œæˆ‘ä»¬éƒ½å»hashæœ‰ä¸€å®šçš„æ¦‚ç‡ä¼šä¸€æ ·ï¼Œå°±åƒä¸Šé¢çš„æƒ…å†µæˆ‘å†æ¬¡å“ˆå¸Œâ€ä¸™å¸…â€œæç«¯æƒ…å†µä¹Ÿä¼šhashåˆ°ä¸€ä¸ªå€¼ä¸Šï¼Œé‚£å°±å½¢æˆäº†é“¾è¡¨ã€‚

![image-20200326222438777](assets/image-20200326222438777.png)

æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šä¿å­˜è‡ªèº«çš„hashã€keyã€valueã€ä»¥åŠä¸‹ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘çœ‹çœ‹Nodeçš„æºç ã€‚

![image-20200326222453409](assets/image-20200326222453409.png)

## æ–°çš„EntryèŠ‚ç‚¹åœ¨æ’å…¥é“¾è¡¨çš„æ—¶å€™ï¼Œæ˜¯æ€ä¹ˆæ’å…¥çš„ä¹ˆï¼Ÿ

**java8ä¹‹å‰æ˜¯å¤´æ’æ³•**ï¼Œå°±æ˜¯è¯´æ–°æ¥çš„å€¼ä¼šå–ä»£åŸæœ‰çš„å€¼ï¼ŒåŸæœ‰çš„å€¼å°±é¡ºæ¨åˆ°é“¾è¡¨ä¸­å»ï¼Œå°±åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œå› ä¸ºå†™è¿™ä¸ªä»£ç çš„ä½œè€…è®¤ä¸ºåæ¥çš„å€¼è¢«æŸ¥æ‰¾çš„å¯èƒ½æ€§æ›´å¤§ä¸€ç‚¹ï¼Œæå‡æŸ¥æ‰¾çš„æ•ˆç‡ã€‚

ä½†æ˜¯ï¼Œ**åœ¨java8ä¹‹åï¼Œéƒ½æ˜¯æ‰€ç”¨å°¾éƒ¨æ’å…¥äº†ã€‚**

é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹HashMapçš„æ‰©å®¹æœºåˆ¶ï¼š

å¸…ä¸™æåˆ°è¿‡äº†ï¼Œæ•°ç»„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæ•°æ®å¤šæ¬¡æ’å…¥çš„ï¼Œåˆ°è¾¾ä¸€å®šçš„æ•°é‡å°±ä¼šè¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯resizeã€‚

> ä»€ä¹ˆæ—¶å€™resizeå‘¢ï¼Ÿ

- Capacityï¼šHashMapå½“å‰é•¿åº¦ã€‚
- LoadFactorï¼šè´Ÿè½½å› å­ï¼Œé»˜è®¤å€¼0.75fã€‚

![](assets/006tNbRwly1g9pdw39rwjj30xi056wf3.jpg)

æ€ä¹ˆç†è§£å‘¢ï¼Œå°±æ¯”å¦‚å½“å‰çš„å®¹é‡å¤§å°ä¸º100ï¼Œå½“ä½ å­˜è¿›ç¬¬76ä¸ªçš„æ—¶å€™ï¼Œåˆ¤æ–­å‘ç°éœ€è¦è¿›è¡Œresizeäº†ï¼Œé‚£å°±è¿›è¡Œæ‰©å®¹ï¼Œä½†æ˜¯HashMapçš„æ‰©å®¹ä¹Ÿä¸æ˜¯ç®€å•çš„æ‰©å¤§ç‚¹å®¹é‡è¿™ä¹ˆç®€å•çš„ã€‚

## æ‰©å®¹ï¼Ÿå®ƒæ˜¯æ€ä¹ˆæ‰©å®¹çš„å‘¢ï¼Ÿ

- æ‰©å®¹ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Entryç©ºæ•°ç»„ï¼Œé•¿åº¦æ˜¯åŸæ•°ç»„çš„2å€ã€‚
- ReHashï¼šéå†åŸEntryæ•°ç»„ï¼ŒæŠŠæ‰€æœ‰çš„Entryé‡æ–°Hashåˆ°æ–°æ•°ç»„ã€‚

## ä¸ºä»€ä¹ˆè¦é‡æ–°Hashå‘¢ï¼Œç›´æ¥å¤åˆ¶è¿‡å»ä¸é¦™ä¹ˆï¼Ÿ

æ˜¯å› ä¸ºé•¿åº¦æ‰©å¤§ä»¥åï¼ŒHashçš„è§„åˆ™ä¹Ÿéšä¹‹æ”¹å˜ã€‚

åŸæ¥é•¿åº¦ï¼ˆLengthï¼‰æ˜¯8ä½ ä½è¿ç®—å‡ºæ¥çš„å€¼æ˜¯2 ï¼Œæ–°çš„é•¿åº¦æ˜¯16,ä½ ä½è¿ç®—å‡ºæ¥çš„å€¼æ˜æ˜¾ä¸ä¸€æ ·äº†ã€‚

æ‰©å®¹å‰ï¼š

![image-20200326222806049](assets/image-20200326222806049.png)

æ‰©å®¹åï¼š 

![image-20200326222839840](assets/image-20200326222839840.png)

> è¯´å®Œæ‰©å®¹æœºåˆ¶æˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼Œä¸ºå•¥ä¹‹å‰ç”¨å¤´æ’æ³•ï¼Œjava8ä¹‹åæ”¹æˆå°¾æ’äº†å‘¢ï¼Ÿ

æˆ‘å…ˆä¸¾ä¸ªä¾‹å­å§ï¼Œæˆ‘ä»¬ç°åœ¨å¾€ä¸€ä¸ªå®¹é‡å¤§å°ä¸º2çš„putä¸¤ä¸ªå€¼ï¼Œè´Ÿè½½å› å­æ˜¯0.75æ˜¯ä¸æ˜¯æˆ‘ä»¬åœ¨putç¬¬äºŒä¸ªçš„æ—¶å€™å°±ä¼šè¿›è¡Œresizeï¼Ÿ

2*0.75 = 1 æ‰€ä»¥æ’å…¥ç¬¬äºŒä¸ªå°±è¦resizeäº†

ç°åœ¨æˆ‘ä»¬è¦åœ¨å®¹é‡ä¸º2çš„å®¹å™¨é‡Œé¢**ç”¨ä¸åŒçº¿ç¨‹**æ’å…¥Aï¼ŒBï¼ŒCï¼Œå‡å¦‚æˆ‘ä»¬åœ¨resizeä¹‹å‰æ‰“ä¸ªçŸ­ç‚¹ï¼Œé‚£æ„å‘³ç€æ•°æ®éƒ½æ’å…¥äº†ä½†æ˜¯è¿˜æ²¡resizeé‚£æ‰©å®¹å‰å¯èƒ½æ˜¯è¿™æ ·çš„ã€‚

**Tipï¼šAçš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ˜¯æŒ‡å‘Bçš„**

![image-20200326222935703](assets/image-20200326222935703.png)

å› ä¸ºresizeçš„èµ‹å€¼æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†**å•é“¾è¡¨çš„å¤´æ’å…¥æ–¹å¼ï¼ŒåŒä¸€ä½ç½®ä¸Šæ–°å…ƒç´ æ€»ä¼šè¢«æ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ä½ç½®**ï¼Œåœ¨æ—§æ•°ç»„ä¸­åŒä¸€æ¡Entryé“¾ä¸Šçš„å…ƒç´ ï¼Œé€šè¿‡é‡æ–°è®¡ç®—ç´¢å¼•ä½ç½®åï¼Œæœ‰å¯èƒ½è¢«æ”¾åˆ°äº†æ–°æ•°ç»„çš„ä¸åŒä½ç½®ä¸Šã€‚

å°±å¯èƒ½å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå¤§å®¶å‘ç°é—®é¢˜æ²¡æœ‰ï¼Ÿ

Bçš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†A

![image-20200326222955452](assets/image-20200326222955452.png)

![image-20200326223028760](assets/image-20200326223028760.png)

ä¸€æ—¦å‡ ä¸ªçº¿ç¨‹éƒ½è°ƒæ•´å®Œæˆï¼Œå°±å¯èƒ½å‡ºç°ç¯å½¢é“¾è¡¨

![image-20200326223050947](assets/image-20200326223050947.png)

å¦‚æœè¿™ä¸ªæ—¶å€™å»å–å€¼ï¼Œæ‚²å‰§å°±å‡ºç°äº†â€”â€”Infinite Loopã€‚

å› ä¸º**java8ä¹‹åé“¾è¡¨æœ‰çº¢é»‘æ ‘**çš„éƒ¨åˆ†ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ä»£ç å·²ç»å¤šäº†å¾ˆå¤šif elseçš„é€»è¾‘åˆ¤æ–­äº†ï¼Œçº¢é»‘æ ‘çš„å¼•å…¥å·§å¦™çš„å°†åŸæœ¬O(n)çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†O(logn)ã€‚

**Tip**ï¼šçº¢é»‘æ ‘çš„çŸ¥è¯†ç‚¹åŒæ ·å¾ˆé‡è¦ï¼Œè¿˜æ˜¯é‚£å¥è¯**ä¸æ‰“æ²¡æŠŠæ¡çš„ä»—**ï¼Œé™äºç¯‡å¹…åŸå› ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œè¿‡å¤šæè¿°äº†ï¼Œä»¥åå†™åˆ°æ•°æ®ç»“æ„å†è¯´å§ï¼Œä¸è¿‡è¦é¢è¯•çš„ä»”ï¼Œè¿˜æ˜¯è¦å‡†å¤‡å¥½ï¼Œåæ­£æˆ‘æ˜¯ç»å¸¸é—®åˆ°çš„ã€‚

**ä½¿ç”¨å¤´æ’**ä¼šæ”¹å˜é“¾è¡¨çš„ä¸Šçš„é¡ºåºï¼Œä½†æ˜¯å¦‚æœ**ä½¿ç”¨å°¾æ’**ï¼Œåœ¨æ‰©å®¹æ—¶ä¼šä¿æŒé“¾è¡¨å…ƒç´ åŸæœ¬çš„é¡ºåºï¼Œå°±ä¸ä¼šå‡ºç°é“¾è¡¨æˆç¯çš„é—®é¢˜äº†ã€‚

å°±æ˜¯è¯´åŸæœ¬æ˜¯A->Bï¼Œåœ¨æ‰©å®¹åé‚£ä¸ªé“¾è¡¨è¿˜æ˜¯A->B

![image-20200326223256965](assets/image-20200326223256965.png)

Java7åœ¨å¤šçº¿ç¨‹æ“ä½œHashMapæ—¶å¯èƒ½å¼•èµ·æ­»å¾ªç¯ï¼ŒåŸå› æ˜¯æ‰©å®¹è½¬ç§»åå‰åé“¾è¡¨é¡ºåºå€’ç½®ï¼Œåœ¨è½¬ç§»è¿‡ç¨‹ä¸­ä¿®æ”¹äº†åŸæ¥é“¾è¡¨ä¸­èŠ‚ç‚¹çš„å¼•ç”¨å…³ç³»ã€‚

Java8åœ¨åŒæ ·çš„å‰æä¸‹å¹¶ä¸ä¼šå¼•èµ·æ­»å¾ªç¯ï¼ŒåŸå› æ˜¯æ‰©å®¹è½¬ç§»åå‰åé“¾è¡¨é¡ºåºä¸å˜ï¼Œä¿æŒä¹‹å‰èŠ‚ç‚¹çš„å¼•ç”¨å…³ç³»ã€‚

> é‚£æ˜¯ä¸æ˜¯æ„å‘³ç€Java8å°±å¯ä»¥æŠŠHashMapç”¨åœ¨å¤šçº¿ç¨‹ä¸­å‘¢ï¼Ÿ

æˆ‘è®¤ä¸ºå³ä½¿ä¸ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œä½†æ˜¯é€šè¿‡æºç çœ‹åˆ°put/getæ–¹æ³•éƒ½æ²¡æœ‰åŠ åŒæ­¥é”ï¼Œå¤šçº¿ç¨‹æƒ…å†µæœ€å®¹æ˜“å‡ºç°çš„å°±æ˜¯ï¼šæ— æ³•ä¿è¯ä¸Šä¸€ç§’putçš„å€¼ï¼Œä¸‹ä¸€ç§’getçš„æ—¶å€™è¿˜æ˜¯åŸå€¼ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨è¿˜æ˜¯æ— æ³•ä¿è¯ã€‚

## HashMapçš„é»˜è®¤åˆå§‹åŒ–é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ

16

æˆ‘ä»¬åœ¨åˆ›å»ºHashMapçš„æ—¶å€™ï¼Œé˜¿é‡Œå·´å·´è§„èŒƒæ’ä»¶ä¼šæé†’æˆ‘ä»¬æœ€å¥½èµ‹åˆå€¼ï¼Œè€Œä¸”æœ€å¥½æ˜¯2çš„å¹‚ã€‚

![](assets/006tNbRwly1g9pluoz10nj30py052gma.jpg)

è¿™æ ·æ˜¯ä¸ºäº†ä½è¿ç®—çš„æ–¹ä¾¿ï¼Œ**ä½ä¸è¿ç®—æ¯”ç®—æ•°è®¡ç®—çš„æ•ˆç‡é«˜äº†å¾ˆå¤š**ï¼Œä¹‹æ‰€ä»¥é€‰æ‹©16ï¼Œæ˜¯ä¸ºäº†æœåŠ¡å°†Keyæ˜ å°„åˆ°indexçš„ç®—æ³•ã€‚

æˆ‘å‰é¢è¯´äº†æ‰€æœ‰çš„keyæˆ‘ä»¬éƒ½ä¼šæ‹¿åˆ°ä»–çš„hashï¼Œä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆå°½å¯èƒ½çš„å¾—åˆ°ä¸€ä¸ªå‡åŒ€åˆ†å¸ƒçš„hashå‘¢ï¼Ÿ

æ˜¯çš„æˆ‘ä»¬é€šè¿‡Keyçš„HashCodeå€¼å»åšä½è¿ç®—ã€‚

æˆ‘æ‰“ä¸ªæ¯”æ–¹ï¼Œkeyä¸ºâ€å¸…ä¸™â€œçš„åè¿›åˆ¶ä¸º766132é‚£äºŒè¿›åˆ¶å°±æ˜¯ 10111011000010110100

![](assets/006tNbRwly1g9pm4zheo1j30hc03yaac.jpg)

æˆ‘ä»¬å†çœ‹ä¸‹indexçš„è®¡ç®—å…¬å¼ï¼šindex = HashCodeï¼ˆKeyï¼‰ & ï¼ˆLength- 1ï¼‰

![](assets/006tNbRwly1g9pmcjsou4j30ca01mjrd.jpg)

15çš„çš„äºŒè¿›åˆ¶æ˜¯1111ï¼Œé‚£10111011000010110100 &1111 åè¿›åˆ¶å°±æ˜¯4

ä¹‹æ‰€ä»¥ç”¨ä½ä¸è¿ç®—æ•ˆæœä¸å–æ¨¡ä¸€æ ·ï¼Œæ€§èƒ½ä¹Ÿæé«˜äº†ä¸å°‘ï¼

> é‚£ä¸ºå•¥ç”¨16ä¸ç”¨åˆ«çš„å‘¢ï¼Ÿ

å› ä¸ºåœ¨ä½¿ç”¨ä¸æ˜¯2çš„å¹‚çš„æ•°å­—çš„æ—¶å€™ï¼ŒLength-1çš„å€¼æ˜¯æ‰€æœ‰äºŒè¿›åˆ¶ä½å…¨ä¸º1ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œindexçš„ç»“æœç­‰åŒäºHashCodeåå‡ ä½çš„å€¼ã€‚

åªè¦è¾“å…¥çš„HashCodeæœ¬èº«åˆ†å¸ƒå‡åŒ€ï¼ŒHashç®—æ³•çš„ç»“æœå°±æ˜¯å‡åŒ€çš„ã€‚

è¿™æ˜¯ä¸ºäº†**å®ç°å‡åŒ€åˆ†å¸ƒ**ã€‚

## é‡å†™equalsæ–¹æ³•çš„æ—¶å€™éœ€è¦é‡å†™hashCodeæ–¹æ³•å‘¢ï¼Ÿ

å› ä¸ºåœ¨javaä¸­ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç»§æ‰¿äºObjectç±»ã€‚Ojbectç±»ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•equalsã€hashCodeï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„ã€‚

åœ¨æœªé‡å†™equalsæ–¹æ³•æˆ‘ä»¬æ˜¯ç»§æ‰¿äº†objectçš„equalsæ–¹æ³•ï¼Œ**é‚£é‡Œçš„ equalsæ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€**ï¼Œæ˜¾ç„¶æˆ‘ä»¬newäº†2ä¸ªå¯¹è±¡å†…å­˜åœ°å€è‚¯å®šä¸ä¸€æ ·

- å¯¹äºå€¼å¯¹è±¡ï¼Œ==æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å€¼
- å¯¹äºå¼•ç”¨å¯¹è±¡ï¼Œæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„åœ°å€

å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘è¯´çš„HashMapæ˜¯é€šè¿‡keyçš„hashCodeå»å¯»æ‰¾indexçš„ï¼Œé‚£indexä¸€æ ·å°±å½¢æˆé“¾è¡¨äº†ï¼Œä¹Ÿå°±æ˜¯è¯´â€å¸…ä¸™â€œå’Œâ€ä¸™å¸…â€œçš„indexéƒ½å¯èƒ½æ˜¯2ï¼Œåœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šçš„ã€‚

æˆ‘ä»¬å»getçš„æ—¶å€™ï¼Œä»–å°±æ˜¯æ ¹æ®keyå»hashç„¶åè®¡ç®—å‡ºindexï¼Œæ‰¾åˆ°äº†2ï¼Œé‚£æˆ‘æ€ä¹ˆæ‰¾åˆ°å…·ä½“çš„â€å¸…ä¸™â€œè¿˜æ˜¯â€ä¸™å¸…â€œå‘¢ï¼Ÿ

**equals**ï¼æ˜¯çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯¹equalsæ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œå»ºè®®ä¸€å®šè¦å¯¹hashCodeæ–¹æ³•é‡å†™ï¼Œä»¥ä¿è¯ç›¸åŒçš„å¯¹è±¡è¿”å›ç›¸åŒçš„hashå€¼ï¼Œä¸åŒçš„å¯¹è±¡è¿”å›ä¸åŒçš„hashå€¼ã€‚

ä¸ç„¶ä¸€ä¸ªé“¾è¡¨çš„å¯¹è±¡ï¼Œä½ å“ªé‡ŒçŸ¥é“ä½ è¦æ‰¾çš„æ˜¯å“ªä¸ªï¼Œåˆ°æ—¶å€™å‘ç°hashCodeéƒ½ä¸€æ ·ï¼Œè¿™ä¸æ˜¯å®ŒçŠŠå­å˜›ã€‚

æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨**HashTable**æˆ–è€…**ConcurrentHashMap**ï¼Œä½†æ˜¯å› ä¸ºå‰è€…çš„**å¹¶å‘åº¦**çš„åŸå› åŸºæœ¬ä¸Šæ²¡å•¥ä½¿ç”¨åœºæ™¯äº†ï¼Œæ‰€ä»¥å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„åœºæ™¯æˆ‘ä»¬éƒ½ä½¿ç”¨çš„æ˜¯ConcurrentHashMapã€‚

HashTableæˆ‘çœ‹è¿‡ä»–çš„æºç ï¼Œå¾ˆç®€å•ç²—æš´ï¼Œç›´æ¥åœ¨æ–¹æ³•ä¸Šé”ï¼Œå¹¶å‘åº¦å¾ˆä½ï¼Œæœ€å¤šåŒæ—¶å…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ŒConcurrentHashMapå°±å¥½å¾ˆå¤šäº†ï¼Œ1.7å’Œ1.8æœ‰è¾ƒå¤§çš„ä¸åŒï¼Œä¸è¿‡å¹¶å‘åº¦éƒ½æ¯”å‰è€…å¥½å¤ªå¤šäº†ã€‚

![](https://tva1.sinaimg.cn/large/006tNbRwly1g9qwe91q6lj30zo0e440r.jpg)

## HashMapå¸¸è§é¢è¯•é¢˜ï¼š

- HashMapçš„åº•å±‚æ•°æ®ç»“æ„ï¼Ÿ
- HashMapçš„å­˜å–åŸç†ï¼Ÿ
- Java7å’ŒJava8çš„åŒºåˆ«ï¼Ÿ
- ä¸ºå•¥ä¼šçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ
- æœ‰ä»€ä¹ˆçº¿ç¨‹å®‰å…¨çš„ç±»ä»£æ›¿ä¹ˆ?
- é»˜è®¤åˆå§‹åŒ–å¤§å°æ˜¯å¤šå°‘ï¼Ÿä¸ºå•¥æ˜¯è¿™ä¹ˆå¤šï¼Ÿä¸ºå•¥å¤§å°éƒ½æ˜¯2çš„å¹‚ï¼Ÿ
- HashMapçš„æ‰©å®¹æ–¹å¼ï¼Ÿè´Ÿè½½å› å­æ˜¯å¤šå°‘ï¼Ÿä¸ºä»€æ˜¯è¿™ä¹ˆå¤šï¼Ÿ
- HashMapçš„ä¸»è¦å‚æ•°éƒ½æœ‰å“ªäº›ï¼Ÿ
- HashMapæ˜¯æ€ä¹ˆå¤„ç†hashç¢°æ’çš„ï¼Ÿ
- hashçš„è®¡ç®—è§„åˆ™ï¼Ÿ

## å¤šçº¿ç¨‹åœºæ™¯

- ä½¿ç”¨Collections.synchronizedMap(Map)åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„mapé›†åˆï¼›
- Hashtable
- ConcurrentHashMap

> å“¦ï¼ŒCollections.synchronizedMapæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„ä½ æœ‰äº†è§£è¿‡ä¹ˆï¼Ÿ

åœ¨SynchronizedMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡Mapï¼Œè¿˜æœ‰æ’æ–¥é”mutexï¼Œå¦‚å›¾

![image-20200326230400810](assets/image-20200326230400810.png)

æˆ‘ä»¬åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å°±éœ€è¦ä¼ å…¥ä¸€ä¸ªMapï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå¦‚æœä½ ä¼ å…¥äº†mutexå‚æ•°ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºä¼ å…¥çš„å¯¹è±¡ã€‚

å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºthisï¼Œå³è°ƒç”¨synchronizedMapçš„å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šé¢çš„Mapã€‚

åˆ›å»ºå‡ºsynchronizedMapä¹‹åï¼Œå†æ“ä½œmapçš„æ—¶å€™ï¼Œå°±ä¼šå¯¹æ–¹æ³•ä¸Šé”ï¼Œå¦‚å›¾å…¨æ˜¯ğŸ”

![image-20200326230452344](assets/image-20200326230452344.png)



## Hashtable è·ŸHashMapä¸ä¸€æ ·

Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼åˆ™éƒ½å¯ä»¥ä¸º nullã€‚

å› ä¸ºHashtableåœ¨æˆ‘ä»¬put ç©ºå€¼çš„æ—¶å€™ä¼šç›´æ¥æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä½†æ˜¯HashMapå´åšäº†ç‰¹æ®Šå¤„ç†

è¿™æ˜¯å› ä¸ºHashtableä½¿ç”¨çš„æ˜¯**å®‰å…¨å¤±è´¥æœºåˆ¶ï¼ˆfail-safeï¼‰**ï¼Œè¿™ç§æœºåˆ¶ä¼šä½¿ä½ æ­¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®ã€‚

> **å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰**æ˜¯javaé›†åˆä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œ åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡ºConcurrent Modification Exceptionã€‚
>
> è¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª modCount å˜é‡ã€‚
>
> é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜modCountçš„å€¼ã€‚
>
> æ¯å½“è¿­ä»£å™¨ä½¿ç”¨hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹modCountå˜é‡æ˜¯å¦ä¸ºexpectedmodCountå€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚
>
> **Tip**ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹modCountå€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº†expectedmodCountå€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚
>
> å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„bugã€‚
>
> java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼ˆè¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼‰ç®—æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶å§ã€‚
>
> **Tip**ï¼š**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**å¤§å®¶ä¹Ÿå¯ä»¥äº†è§£ä¸‹ï¼Œjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚
>
> 



å¦‚æœä½ ä½¿ç”¨nullå€¼ï¼Œå°±ä¼šä½¿å¾—å…¶æ— æ³•åˆ¤æ–­å¯¹åº”çš„keyæ˜¯ä¸å­˜åœ¨è¿˜æ˜¯ä¸ºç©ºï¼Œå› ä¸ºä½ æ— æ³•å†è°ƒç”¨ä¸€æ¬¡contain(keyï¼‰æ¥å¯¹keyæ˜¯å¦å­˜åœ¨è¿›è¡Œåˆ¤æ–­ï¼ŒConcurrentHashMapåŒç†ã€‚

- **å®ç°æ–¹å¼ä¸åŒ**ï¼šHashtable ç»§æ‰¿äº† Dictionaryç±»ï¼Œè€Œ HashMap ç»§æ‰¿çš„æ˜¯ AbstractMap ç±»ã€‚

  Dictionary æ˜¯ JDK 1.0 æ·»åŠ çš„ï¼Œè²Œä¼¼æ²¡äººç”¨è¿‡è¿™ä¸ªï¼Œæˆ‘ä¹Ÿæ²¡ç”¨è¿‡ã€‚

- **åˆå§‹åŒ–å®¹é‡ä¸åŒ**ï¼šHashMap çš„åˆå§‹å®¹é‡ä¸ºï¼š16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸ºï¼š11ï¼Œä¸¤è€…çš„è´Ÿè½½å› å­é»˜è®¤éƒ½æ˜¯ï¼š0.75ã€‚

- **æ‰©å®¹æœºåˆ¶ä¸åŒ**ï¼šå½“ç°æœ‰å®¹é‡å¤§äºæ€»å®¹é‡ * è´Ÿè½½å› å­æ—¶ï¼ŒHashMap æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ï¼ŒHashtable æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ + 1ã€‚

- **è¿­ä»£å™¨ä¸åŒ**ï¼šHashMap ä¸­çš„ Iterator è¿­ä»£å™¨æ˜¯ fail-fast çš„ï¼Œè€Œ Hashtable çš„ Enumerator ä¸æ˜¯ fail-fast çš„ã€‚

  æ‰€ä»¥ï¼Œå½“å…¶ä»–çº¿ç¨‹æ”¹å˜äº†HashMap çš„ç»“æ„ï¼Œå¦‚ï¼šå¢åŠ ã€åˆ é™¤å…ƒç´ ï¼Œå°†ä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸ï¼Œè€Œ Hashtable åˆ™ä¸ä¼šã€‚





## ConcurrentHashMap

- [01-HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨.md](../../03-concurrency/08-Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶/01-ConcurrentHashMapåŸç†ä¸ä½¿ç”¨/01-HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨.md) 

-  [02-ConcurrentHashMapåŸç†.md](../../03-concurrency/08-Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶/01-ConcurrentHashMapåŸç†ä¸ä½¿ç”¨/02-ConcurrentHashMapåŸç†.md) 